- hosts: all
  become: true
  vars:
    awx_project_name: SAP
    awx_projects_dir: /var/lib/awx/projects
    awx_project_subdir: sap-iac
    awx_project_path: '{{ awx_projects_dir }}/{{ awx_project_subdir }}'
  tasks:
  - name: ensure awx project path is present
    file:
      path: '{{ awx_project_path }}'
      mode: 0755
      state: directory
  - name: copy sap-iac repo to awx project path
    unarchive:
      src: '{{ playbook_dir }}/sap-iac.tar.gz'
      dest: '{{ awx_project_path }}'
  - name: define job directories
    shell: |
      find {{ awx_project_path }}/stacks -name awx_survey_spec.json | awk -F / '{print $(NF-1)}'
    register: job_directories
    changed_when: false
  - name: wait for tower to initialize
    shell: |
      docker logs awx_task 2>&1 | grep 'Demo Credential, Inventory, and Job Template added'
    register: tower_initialized
    retries: 60
    delay: 15
    until: tower_initialized is succeeded
    changed_when: false
  - name: delete demo tower job template
    tower_job_template:
      job_type: run
      name: Demo Job Template
      playbook: playbook.yml
      project: Demo Project
      state: absent
      tower_host: http://localhost
      tower_username: admin
      tower_password: password
      validate_certs: false
    failed_when: false
  - name: delete demo tower project
    tower_project:
      name: Demo Project
      organization: Default
      state: absent
      tower_host: http://localhost
      tower_username: admin
      tower_password: password
      validate_certs: false
    failed_when: false
  - name: delete demo tower inventory
    tower_inventory:
      name: Demo Inventory
      organization: Default
      state: absent
      tower_host: http://localhost
      tower_username: admin
      tower_password: password
      validate_certs: false
    failed_when: false
  - name: add tower project
    tower_project:
      name: '{{ awx_project_name }}'
      local_path: '{{ awx_project_subdir }}'
      organization: Default
      scm_type: manual
      tower_host: http://localhost
      tower_username: admin
      tower_password: password
      validate_certs: false
  - name: add tower localhost inventory
    tower_inventory:
      name: default
      organization: Default
      tower_host: http://localhost
      tower_username: admin
      tower_password: password
      validate_certs: false
  - name: add localhost to tower default inventory
    tower_host:
      inventory: default
      name: localhost
      tower_host: http://localhost
      tower_username: admin
      tower_password: password
      validate_certs: false
  - name: read tower survey specs
    slurp:
      src: '{{ awx_project_path }}/stacks/{{ item }}/awx_survey_spec.json'
    register: job_survey_specs
    loop: '{{ job_directories.stdout_lines }}'
  - name: add quickstart tower job templates
    tower_job_template:
      name: '{{ item.0 }}'
      concurrent_jobs_enabled: true
      inventory: default
      job_type: run
      playbook: 'stacks/{{ item.0 }}/playbook.yml'
      project: '{{ awx_project_name }}'
      survey_enabled: true
      survey_spec: '{{ item.1 }}'
      tower_host: http://localhost
      tower_username: admin
      tower_password: password
      validate_certs: false
    loop: '{{ job_directories.stdout_lines | zip(job_survey_specs.results | map(attribute="content") | map("b64decode")) | list }}'
  - name: add expert tower job templates
    tower_job_template:
      name: '{{ item }} (Expert Mode)'
      ask_extra_vars: true
      ask_inventory: true
      ask_skip_tags: true
      ask_tags: true
      concurrent_jobs_enabled: true
      inventory: default
      job_type: run
      playbook: 'stacks/{{ item }}/playbook.yml'
      project: '{{ awx_project_name }}'
      tower_host: http://localhost
      tower_username: admin
      tower_password: password
      validate_certs: false
    loop: '{{ job_directories.stdout_lines }}'
  - name: intentionally exit with error in dev mode to prevent image being created
    command: 'false'
    when: dev_mode | bool
