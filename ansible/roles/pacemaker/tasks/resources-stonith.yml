---
- block:
  - command: pcs property show
    register: pcs_command_status
    changed_when: false
  - name: configure property startup-fencing
    command: pcs property set startup-fencing=true
    when: |
      'startup-fencing: true' not in pcs_command_status.stdout
  - name: configure property stonith-enabled
    command: pcs property set stonith-enabled=true
    when: |
      'stonith-enabled: true' not in pcs_command_status.stdout

  - command: |
      pcs stonith show STONITH-{{ sap_primary_instance }}
    register: stonith_primary_status
    changed_when: false
    failed_when: false

  - name: configure stonith for primary
    command: >-
      pcs stonith create STONITH-{{ sap_primary_instance }} fence_gce
      port={{ sap_primary_instance }}
      zone={{ sap_primary_zone }}
      project={{ project_id }}
    when: stonith_primary_status.rc != 0

  - command: |
      pcs stonith show STONITH-{{ sap_secondary_instance }}
    register: stonith_secondary_status
    changed_when: false
    failed_when: false

  - name: configure stonith for secondary
    command: >-
      pcs stonith create STONITH-{{ sap_secondary_instance }} fence_gce
      port={{ sap_secondary_instance }}
      zone={{ sap_secondary_zone }}
      project={{ project_id }}
    when: stonith_primary_status.rc != 0

  - name: configure stonith location constraint for primary
    command: >-
      pcs constraint location STONITH-{{ sap_primary_instance }}
      prefers {{ sap_secondary_instance }}=INFINITY

  - name: configure stonith location constraint for secondary
    command: >-
      pcs constraint location STONITH-{{ sap_secondary_instance }}
      prefers {{ sap_primary_instance }}=INFINITY
  when: |
    ansible_os_family == 'RedHat'

- block:
  - command: >-
      crm configure get_property stonith-timeout
    register: crm_command_status
    changed_when: false
  - name: configure property stonith-timeout
    command: >-
      crm configure property stonith-timeout
    when: |
      crm_command_status.stdout != '300s'

  - command: >-
      crm configure get_property stonith-enabled
    register: crm_command_status
    changed_when: false
  - name: configure property stonith-enabled
    command: >-
      crm configure property stonith-enabled=true
    when: |
      crm_command_status.stdout != 'true'

  - name: configure stonith for primary
    command: >-
      crm configure primitive STONITH-{{ sap_primary_instance }} stonith:external/gcpstonith
      op monitor interval=300s timeout=60s on-fail=restart
      op start interval=0 timeout=60s onfail=restart
      params instance_name={{ sap_primary_instance }} gcloud_path="{{ sap_gcloud_path }}" logging=yes
      meta failure-timeout=3600
    register: crm_command_status
    changed_when: crm_command_status.rc == 0
    failed_when: |
      'Found existing primitive with same ID' not in crm_command_status.stderr and crm_command_status.rc != 0

  - name: configure stonith for secondary
    command: >-
      crm configure primitive STONITH-{{ sap_secondary_instance }} stonith:external/gcpstonith
      op monitor interval=300s timeout=60s on-fail=restart
      op start interval=0 timeout=60s onfail=restart
      params instance_name={{ sap_secondary_instance }} gcloud_path="{{ sap_gcloud_path }}" logging=yes
      meta failure-timeout=3600
    register: crm_command_status
    changed_when: crm_command_status.rc == 0
    failed_when: |
      'Found existing primitive with same ID' not in crm_command_status.stderr and crm_command_status.rc != 0

  - name: configure location stonith for primary
    command: >-
      crm configure location LOC_STONITH-{{ sap_primary_instance }}
      STONITH-{{ sap_primary_instance }} -inf: {{ sap_primary_instance }}
    register: crm_command_status
    changed_when: crm_command_status.rc == 0
    failed_when: |
      'Found existing location with same ID' not in crm_command_status.stderr and crm_command_status.rc != 0

  - name: configure location stonith for secondary
    command: >-
      crm configure location LOC_STONITH-{{ sap_secondary_instance }}
      STONITH-{{ sap_secondary_instance }} -inf: {{ sap_secondary_instance }}
    register: crm_command_status
    changed_when: crm_command_status.rc == 0
    failed_when: |
      'Found existing location with same ID' not in crm_command_status.stderr and crm_command_status.rc != 0
  when: |
    ansible_os_family == 'Suse'
