---

- name: Include copy ssh keys role
  include_role:
    name: sap-hana-copy-ssh-keys

- name: Create {{ sap_hana_sid }} directories in /hana/data and /hana/log
  file:
    path: "{{ item }}/{{ sap_hana_sid }}"
    state: directory
    mode: 0777
  with_items:
    - "{{ sap_hana_data_mountpoint }}"
    - "{{ sap_hana_log_mountpoint }}"

- name: 'Create {{ sap_hana_shared_mountpoint }} and {{ sap_hana_backup_mountpoint }}'
  file:
    path: '{{ item }}'
    state: directory
    recurse: true
    mode: 0777
  with_items:
    - '{{ sap_hana_shared_mountpoint }}'
    - '{{ sap_hana_backup_mountpoint }}'

- name: 'Mount {{ sap_hana_shared_mountpoint }} and {{ sap_hana_backup_mountpoint }} filestore volumes'
  mount:
    src: '{{ item.source }}'
    path: '{{ item.path }}'
    state: mounted
    fstype: nfs
  loop:
    - { source: '{{ sap_hana_shared_fs_mount_point }}', path: '{{ sap_hana_shared_mountpoint }}' }
    - { source: '{{ sap_hana_backup_fs_mount_point }}', path: '{{ sap_hana_backup_mountpoint }}' }

- name: Ensure pip is installed.
  package:
    name: python2-pip
    state: present
  register: pip_installed

- name: Install required python package from GCE storage client
  pip:
    name: pyasn1-modules

- name: Create gcloud directory under sidadm user home directory
  file:
    path: '{{ sap_hana_usr_mountpoint }}/{{ sap_hana_sid }}/home/.config/gcloud/'
    state: directory
    owner: '{{ sap_hana_system_uid }}'
    group: '{{ sap_sapsys_gid }}'
    recurse: true

- name: Updating /etc/sudoers
  lineinfile:
    path: /etc/sudoers
    line: '{{ item }}'
  with_items:
    - '{{ sap_hana_user }} ALL=NOPASSWD: /sbin/multipath,/sbin/multipathd,/etc/init.d/multipathd,/usr/bin/sg_persist,/bin/mount,/bin/umount,/bin/kill,/usr/bin/lsof,/usr/bin/systemctl,/usr/sbin/lsof,/usr/sbin/xfs_repair,/usr/bin/mkdir,/sbin/vgscan,/sbin/pvscan,/sbin/lvscan,/sbin/vgchange,/sbin/lvdisplay,/usr/bin/gcloud'
    - ''

- name: 'Remove {{ sap_hana_gce_storage_client_path }}/gceStorageClient.pyc'
  file:
    path: '{{ sap_hana_gce_storage_client_path }}/gceStorageClient.pyc'
    state: absent

- name: 'Change {{ sap_hana_gce_storage_client_path }}/gceStorageClient.py permissions'
  file:
    path: '{{ sap_hana_gce_storage_client_path }}/gceStorageClient.py'
    mode: 0755
